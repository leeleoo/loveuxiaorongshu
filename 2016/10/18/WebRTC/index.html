<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> WebRTC · snow</title><meta name="description" content="WebRTC - leeleo"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/notebook/favicon.png"><link rel="stylesheet" href="/notebook/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://leeleoo.github.io/notebook/atom.xml" title="snow"></head><body><div class="wrap"><header><a href="/notebook/" class="logo-link"><img src="/notebook/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/notebook/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/notebook/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/sunchongsheng" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/pinggod" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/notebook/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">WebRTC</h1><div class="post-info">Oct 18, 2016</div><div class="post-content"><h2 id="1-获取用户媒体"><a href="#1-获取用户媒体" class="headerlink" title="1.获取用户媒体"></a>1.获取用户媒体</h2> <figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">navigator.getUserMedia(</div><div class="line">  &#123; <span class="attr">video</span>: <span class="literal">true</span>, <span class="attr">audio</span>: <span class="literal">false</span> &#125;,</div><div class="line">  <span class="function"><span class="keyword">function</span> (<span class="params">myStream</span>) </span>&#123;</div><div class="line">    stream = myStream;</div><div class="line">    yourVideo.src = <span class="built_in">window</span>.URL.createObjectURL(stream);</div><div class="line">    <span class="keyword">if</span> (hasRTCPeerConnection()) &#123;</div><div class="line">true   <span class="comment">//创建PeerConnection</span></div><div class="line">      setupPeerConnection(stream);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      alert(<span class="string">"Sorry, your browser does not support WebRTC."</span>);</div><div class="line">    &#125;</div><div class="line">  &#125;, </div><div class="line">  <span class="function"><span class="keyword">function</span> (<span class="params">error</span>) </span>&#123;</div><div class="line">      <span class="built_in">console</span>.log(error);</div><div class="line">  &#125;</div><div class="line">);</div></pre></td></tr></table></figure>
<a id="more"></a>
<h4 id="1-1创建RTCPeerConnectioninit"><a href="#1-1创建RTCPeerConnectioninit" class="headerlink" title="1.1创建RTCPeerConnectioninit"></a>1.1创建RTCPeerConnection<code>init</code></h4><blockquote>
<h4 id="这里主要做了四件事情"><a href="#这里主要做了四件事情" class="headerlink" title="这里主要做了四件事情"></a>这里主要做了四件事情</h4></blockquote>
<ol>
<li>创建RTCPeerConnection对象</li>
<li>给它添加媒体stream</li>
<li>给它添加onaddstream事件</li>
<li>给它添加onicecandidate事件</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">setupPeerConnection</span>(<span class="params">stream</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> configuration = &#123;</div><div class="line">    <span class="string">"iceServers"</span>: [&#123; <span class="string">"url"</span>: <span class="string">"stun:127.0.0.1:9876"</span> &#125;]</div><div class="line">  &#125;;</div><div class="line">  yourConnection = <span class="keyword">new</span> RTCPeerConnection(configuration);</div><div class="line"></div><div class="line">  <span class="comment">// Setup stream listening</span></div><div class="line">  yourConnection.addStream(stream);</div><div class="line">  yourConnection.onaddstream = <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</div><div class="line">    theirVideo.src = <span class="built_in">window</span>.URL.createObjectURL(e.stream);</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  <span class="comment">// Setup ice handling</span></div><div class="line">  yourConnection.onicecandidate = <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (event.candidate) &#123;</div><div class="line">      send(&#123;</div><div class="line">        type: <span class="string">"candidate"</span>,</div><div class="line">        candidate: event.candidate</div><div class="line">      &#125;);</div><div class="line">    &#125;</div><div class="line">  &#125;;</div><div class="line">  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="2-createOffercall"><a href="#2-createOffercall" class="headerlink" title="2.createOffercall"></a>2.createOffer<code>call</code></h2><blockquote>
<p>建立 SDP会话描述协议 offer 和 answer</p>
<p>创建之后发送给服务器<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">startPeerConnection</span>(<span class="params">user</span>) </span>&#123;</div><div class="line">  connectedUser = user;</div><div class="line"></div><div class="line">  <span class="comment">// Begin the offer</span></div><div class="line">  yourConnection.createOffer(<span class="function"><span class="keyword">function</span> (<span class="params">offer</span>) </span>&#123;</div><div class="line">    send(&#123;</div><div class="line">      type: <span class="string">"offer"</span>,</div><div class="line">      offer: offer</div><div class="line">    &#125;);</div><div class="line">    yourConnection.setLocalDescription(offer);</div><div class="line"></div><div class="line">  &#125;, <span class="function"><span class="keyword">function</span> (<span class="params">error</span>) </span>&#123;</div><div class="line">    alert(<span class="string">"An error has occurred."</span>);</div><div class="line">  &#125;);</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
</blockquote>
<h4 id="2-1-createAnswer-call"><a href="#2-1-createAnswer-call" class="headerlink" title="2.1 createAnswer call"></a>2.1 createAnswer <code>call</code></h4><blockquote>
<p>服务器收到offer之后反馈给客户端,客户端发送 answer<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">onOffer</span>(<span class="params">offer, name</span>) </span>&#123;</div><div class="line">  connectedUser = name;</div><div class="line"></div><div class="line">  yourConnection.setRemoteDescription(<span class="keyword">new</span> RTCSessionDescription(offer));</div><div class="line"></div><div class="line">  yourConnection.createAnswer(<span class="function"><span class="keyword">function</span> (<span class="params">answer</span>) </span>&#123;</div><div class="line">    yourConnection.setLocalDescription(answer);</div><div class="line">    send(&#123;</div><div class="line">      type: <span class="string">"answer"</span>,</div><div class="line">      answer: answer</div><div class="line">    &#125;);</div><div class="line">  &#125;, <span class="function"><span class="keyword">function</span> (<span class="params">error</span>) </span>&#123;</div><div class="line">    alert(<span class="string">"An error has occurred"</span>);</div><div class="line">  &#125;);</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
</blockquote>
<h4 id="2-2-响应-Answercall"><a href="#2-2-响应-Answercall" class="headerlink" title="2.2 响应 Answercall"></a>2.2 响应 Answer<code>call</code></h4><blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">onAnswer</span>(<span class="params">answer</span>) </span>&#123;</div><div class="line"></div><div class="line">  yourConnection.setRemoteDescription(<span class="keyword">new</span> RTCSessionDescription(answer));</div><div class="line">  </div><div class="line">&#125;;</div></pre></td></tr></table></figure>
</blockquote>
<h2 id="3-Question"><a href="#3-Question" class="headerlink" title="3.Question"></a>3.Question</h2><p>既然 webrtc 能实现点对点传输视频和音频, 那能不能 …..  能!</p>
<p>当然可以传点其他东西</p>
<h4 id="使用-DataChannel"><a href="#使用-DataChannel" class="headerlink" title="使用 DataChannel"></a>使用 DataChannel</h4><p>1.创建<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yourConnection.createDataChannel(<span class="string">'name'</span>,options)</div></pre></td></tr></table></figure></p>
<p>第一个参数是卖萌的随便取一个就行了</p>
<p>这里的 options 可以搞下面的事情</p>
<hr>
<ul>
<li>reliable <code>设置消息传递是否进行担保(担保?黑人问号)</code></li>
<li>ordered <code>用来设置消息的接受是否需要按照发送时的顺序</code></li>
<li>maxRetransmitTime <code>设置消息发送失败时,多久重新发送</code></li>
<li>maxRetransmits <code>设置消息发送失败时,最多重发几次</code></li>
<li>protocol <code>设置强制使用其他子协议</code></li>
<li>negotiated <code>此选项用来设置开发人员是否有责任在两边创建数据通道,还是浏览器来自动完成这个步骤</code></li>
<li>id  <code>ID 本人亲测不设ID 根本连不上</code></li>
</ul>
<p>这里我只想说,我不是针对id, 我是说, 在座的options,都是辣鸡(开个小玩耍)<br><strong>说说我对这几个配置的感受</strong></p>
<ul>
<li>首先 ID 感觉是必填的. 这应该是链路层的地址,不然你知道传给谁?</li>
<li>然后有几个可配置的属性 <code>reliable</code> <code>ordered</code> <code>maxRetransmitTime</code> <code>maxRetransmits</code></li>
<li>最后两个值得注意的属性 <code>protocol</code> <code>negotiated</code> 并不知道有什么用(先挖坑,日后再填)</li>
</ul>
<hr>
<blockquote>
<p>negotiated<br>当此属性为 TRUE 时</p>
</blockquote>
<p>这里会有一个 ondatachannel 事件触发在 RTCPeerConnection 对象上本来由浏览器自动处理的数据通道现在必须由你来创建一个相同 ID 的数据通道</p>
<hr>
<p>DataChannel 非常容易使用这里有几个事件和几个方法</p>
<h4 id="事件"><a href="#事件" class="headerlink" title="事件"></a>事件</h4><ul>
<li>onerror</li>
<li>onmessage</li>
<li>onopen</li>
<li>onclose</li>
</ul>
<p>其中 onerror 和 onmessage 会传递一个参数供你使用</p>
<h4 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h4><ul>
<li>dataChannel.send</li>
</ul>
<p>意思已经很明显了. 其中发送的内容可以如下几种类型                                </p>
<ol>
<li>String </li>
<li>Blob</li>
<li>ArrayBuffer</li>
<li>ArrayBufferView</li>
</ol>
<p><a href="http://www.jb51.net/article/58281.htm" target="_blank" rel="external">什么是 ArrayBuffer</a><br><a href="http://javascript.ruanyifeng.com/stdlib/arraybuffer.html#toc0" target="_blank" rel="external">阮一峰:ArrayBuffer</a></p>
<p>所以你有可能写这样的代码<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">dataChannel.onmessage = <span class="function"><span class="keyword">function</span>(<span class="params">event</span>)</span>&#123;</div><div class="line">true<span class="keyword">var</span> data = event.data;</div><div class="line">true<span class="keyword">if</span>(data <span class="keyword">instanceof</span> Blob)&#123;</div><div class="line">truetrue</div><div class="line">true&#125;<span class="keyword">else</span> <span class="keyword">if</span>(data <span class="keyword">instanceof</span> <span class="built_in">ArrayBuffer</span>)&#123;</div><div class="line">truetrue </div><div class="line">true&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="4-让我们来传点真正的东西吧"><a href="#4-让我们来传点真正的东西吧" class="headerlink" title="4. 让我们来传点真正的东西吧!"></a>4. 让我们来传点真正的东西吧!</h2><blockquote>
<p>首先要明确一点,  由于种种原因, 我们只能通过 base64 来传输数据 (是的, 这不是你家,这是浏览器,想在这里搞事情,就得听浏览器的,为什么?因为 js 和 底层网络协议有很多不可描述的约定, 所以大家商量就用可读字符串来传输数据吧    )</p>
</blockquote>
<p>由于上面的BUG, 噢, 不 特性,,, 我们的流程会是这样的</p>
<ol>
<li>先利用filereaderAPI 把文件 convert 为 buffer <code>reader.readAsArrayBuffer(file)</code></li>
<li>使用 <code>String.fromCharCode[int]</code> 返回对应整数编码的字符</li>
<li>使用 <code>btoa</code> 转换为base64编码</li>
<li>接收端拿到 base64 使用 <code>String.charCodeAt[string]</code> 返回 <code>Unicode</code> 编码</li>
<li>组装生成 BufferArray</li>
<li>最后变成 <code>new Blob(byteArrays, {type: contentType})</code></li>
</ol>
<p>然后下载<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">saveFile</span>(<span class="params">meta, data</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> blob = base64ToBlob(data, meta.type);</div><div class="line">  <span class="keyword">var</span> link = <span class="built_in">document</span>.createElement(<span class="string">'a'</span>);</div><div class="line">  link.href = <span class="built_in">window</span>.URL.createObjectURL(blob);</div><div class="line">  link.download = meta.name;</div><div class="line">  link.click();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="5-移动端的适配"><a href="#5-移动端的适配" class="headerlink" title="5.移动端的适配"></a>5.移动端的适配</h2><p> IOS 无法使用 不想适配了</p>
</div></article></div></main><footer><div class="paginator"><a href="/notebook/2016/10/18/react技术栈/" class="prev">PREV</a></div><div class="copyright"><p>© 2015 - 2017 <a href="http://leeleoo.github.io/notebook">leeleo</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>